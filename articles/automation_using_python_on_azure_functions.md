---
title: "（執筆中）Azure Functions + Python(openpyxl)で毎月のExcel集計を自動化した"
emoji: "📊"
type: "tech"
topics: ["azurefunctions", "python", "openpyxl", "excel"]
published: true
---

# 何やったの

業務で月に1度、サービスのユーザ利用集計をExcelにまとめており、その作業に約3時間かかっていたのですが、それを0にしました。

Pythonファイルに3時間分の苦悩(後述)を900行程で詰め込み、それをAzure FunctionsのTimer Trigger機能で自動的に月一実行し、出力結果としているExcelファイルをAzure Blob Storageの指定したコンテナに格納します。

今後は月に1度そのコンテナを見に行って、作成されているExcelファイルをダウンロードするだけで集計表が手に入る状態になりました。最高です。

# 背景

集計にかかっていた3時間の質が、以下の点で良くありませんでした。

- 機械的な作業なので退屈
- 手動なので人的ミスが起こり放題
- 成長に繋がらない

具体的には以下の内容を行っていました。

1. 実行したいSQLファイル(複数)が格納されている社内のGitLabプロジェクトを見に行く
   1. SQLを複数ファイルに分けている理由は、今回使用した`pandas.read_sql()`メソッドのエラー回避[^1]のためです
2. [SSMS](https://learn.microsoft.com/ja-jp/ssms/install/install)(SQL Server Management Studio)にコピペして実行
3. 実行結果をコピーして集計Excelファイルに貼り付け

[^1]: [pandas](https://pandas.pydata.org/)の[`read_sql()`](https://pandas.pydata.org/docs/reference/api/pandas.read_sql.html)メソッドは、第一引数のSQLテキストを読み取り、実行までしてくれる便利なものですが、読み取れるSQLステートメントの数が最大1つまでという制約があります。例えば以下のコードはエラーになります。
    ```sql
    USE [Sample-Database];
    SELECT * FROM [Sample-Table];
    ```
    そのため別データベースに接続するSQLは別ファイルに分離し、それぞれを別の`read_sql()`で実行する必要がありました。

---

これを部分的にでも、できる限り自動化したいと思い少しずつ試してみたら、最終的に完全自動化をすることができ、3時間が0になった(やったね)ので、その方法やプログラムを共有します。


# 下書きメモ

- Azure Functionsはあくまで実行環境で、それを**定期**実行させたいならTimer Trigger機能を使う必要がある。
で、これはazure functionsに内包されている機能でgui上でポチポチ設定するだけでやれるんだろうなとか思っていたが、そうではなく完全にコードベースで、timer trigger機能を使用するためのpythonの書き方、というのがバージョンごとに分かれて存在しており、それに従ってコードを書く必要がある。まぁほぼコピペでいけて簡単なので問題はない。

- timer trigger v2のcron式、utcだから気をつけて。自分はdatetime.now()をdatetime.now(ZoneInfo('Asia/Tokyo'))に変更することで解決した。

- flex consumptionだとremote buildという便利な機能があり、手元でpythonをビルドする必要がなく、またrequirements.txtさえ用意しておけばリモートでそれを自動でインストールしてくれるっぽく、凄く楽にデプロイ成功して良かった。

- 最初matplotlibで図を作ろうとしていたが、既存のexcelの図をopenpyxlで取得していじるところまでやっちゃえば良いことに気づいて楽にグラフを拡張できてよかった。スタイル引き継げるのが良い

- 最初はローカルでこういう風に実行して試してた。毎回sql走って実行を5~10分待つのが面倒だったが、本番に近い状態で正常に実行されるか常に確認しておきたかったので我慢した

- 最後の方は急いでいてリファクタしてないのだが、ご愛嬌

- 余談だがexcelなどのmsアプリのファイルは内部でxmlになっていること、だからこそ .xlsx / .docx / .pptx のxはxmlのxとして使われていること、を知った。で、グラフのタイトルが消えてしまうときとかにxmlの中身を見に行ってxmlが存在しないからxmlとは違って内部キャッシュを恐らくexcelはもっていてそこが消えてしまったんだろうとかそういうアタリをつけられて、楽しかった。実際に1文字消す、戻す、とやってxmlにそれが認識されていることを確認し、再度実行したらちゃんと直ったので、良かった。
 
 - 集計表がおかしいとか、ある時点での集計表をもう一度見たいとか、集計表を見る営業サイドだけでなく開発サイド(主に私)も過去の集計表が見たいということで、月ごとの集計表はファイル名の末尾に`_old`をつけて一応スナップショットとして保存しておくことにしている
