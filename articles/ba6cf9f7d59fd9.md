---
title: "ReactのuseStateってどういう仕組み？Q&A形式で基礎固め"
emoji: "👀"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["react", "usestate"]
published: false
---

Reactの基礎固めの一環で、useStateについてまとめてみます。
少しでも気になるところがあればぜひご意見いただきたいです！

# メモ
再レンダリングは実際に何をやってんの？
再レンダリングの後にDOMを変更するってことは、DOMの変更は再レンダリングに含まれないの？
Reactの公式ドキュメントのあの部分全部読む
set関数呼ばれた時の再レンダリングスケジューリング要らなくね？


参照
https://ja.react.dev/learn/render-and-commit

# 再レンダリングとは？ページ(ブラウザ)再読み込みと何が違う？
これは普通に学ぶ。

# 前提: 落とし穴
stateの**更新**というのはset関数が呼び出されたというだけの意味であって、値が**変更**されていない場合でもset関数が呼び出されたならそれは**更新**と呼ぶ。これは本来の"更新"という言葉の意味とは全く違うので気付くのに時間がかかった。

公式でも
> 更新の前後で state の値が変化しない場合、その変更は無視されます

と言っている。それはつまり「**変更**されない**更新**は存在する」ということになる。
https://ja.react.dev/reference/react/useState

# Q1. なぜuseStateでは「state更新」「再レンダリング」を即実行せずにわざわざスケジューリング(予約)するの？

**A. 効率化・最適化のため。**

複数のset関数による再レンダリングを毎回行うと再レンダリングの回数が多くなってしまうから。言い換えると、無駄な再レンダリングが増えるから。

なので、スケジューリングされた「バッチ処理(まとまった処理)」としてset関数の処理を1つにまとめることで対処している。→後にまとめて**1回の**再レンダリングで済ますことができる。

# Q2. 「state更新」「再レンダリング」がスケジューリングされるのはいつ？

**A. set関数が呼ばれた時にどちらもスケジューリングされる。**

# Q3. スケジューリングされた「state更新」「再レンダリング」が実際に実行されるのはいつ？

**A. 「state更新」と「再レンダリング」は以下のような流れで行われる。**

1. set関数が呼び出されると、Reactは新しいstateを内部的にキューに入れる（キューイング）。「state更新」「再レンダリング」の両方をスケジューリングする。

2. Reactは、現在の実行コンテキスト（例：イベントハンドラ）が完了するまで待つ。

3. その後、キューに入れられた全てのstate更新を処理する。この時点で、コンポーネントのstateが実際に更新される。

4. すべてのstateが更新された後、更新されたstateが変更もされていたらスケジューリングされていた再レンダリングを実行する。更新されただけで変更はされていないならスケジューリングされていた再レンダリングはスキップされる。

5. 再レンダリング実行後、変更後のstateを反映した仮想DOMが生成される。

6. 仮想DOMと実際のDOMを比較し（差分検出）、必要な変更のみ実際のDOMに適用する。

# Q4. state更新後の(最新の)stateを参照したい場合はどうすれば良い？
これまでの説明を踏まえればわかるように、set関数を呼び出した直後に新しいstateを参照しようとしても、更新前の古い値しか得られない。例えば、以下の様に書いても、`console.log(state)`の出力結果は0である。

```tsx
const [state, setState] = useState(0);

setState(state + 1); // ここで即時更新されている訳ではないので...
console.log(state) // この結果は1ではなくまだ0のまま
```

つまり、set関数は非同期処理なのである。
しかし非同期処理だからと言ってasync/awaitなどを使える訳でもない。
→ではどうやって最新の(変更後の)stateを取得するのか？という疑問。

**A. `useEffect`を使用する。**

他にも`useLayoutEffect`を使用するか、Reactの`flushSync`関数を使用するなどの方法はあるらしいが、今回は割愛。

useEffectの依存配列に、変更を検知したいstateを入れれば、それが変更された後にuseEffect内の処理が実行される。

例えば先ほどのstateの例で言えば、以下の様に書くことができる。

```tsx
aaa
```
